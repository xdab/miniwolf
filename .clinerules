# .clinerules - Technical Rules for miniwolf

A minimalist C soundcard modem/TNC for Bell 202 (1200 bps) amateur radio. Lightweight Direwolf replacement with packet radio/APRS support. Custom DSP, real-time audio via ALSA, offline file processing.

## Real-Time Constraints (Critical)

- **No malloc/free/locks/IO/syscalls in audio callback** (audio_input_callback in loop.c)
- Use 32-bit `float` only (not `double`) for DSP—smaller memory footprint
- Static buffers and pre-allocated structures throughout
- Callback-based architecture for ALSA integration

## Code Style

- **Minimal comments**—self-explanatory code preferred
- **Function prefixes** group related functionality: `bf_` (filter), `aud_` (audio), `agc_` (gain control), `fft_`, `grz_` (Goertzel), `demod_*`, `bitclk*`, `modem_`, `mod_`, `ring_`, `sql_` (squelch), `dedupe_`, `mavg_`/`ema_` (averages)
- **Struct-based organization** with `init()`, `process()`, `free()` pattern
- **Buffer safety**: Always pass buffer size, verify available capacity before writes
- **Error codes**: 0 = success, negative = error
- **Goto for cleanup** only in main functions

## Module Breakdown

**Amateur protocols** (in [libtnc](libs/libtnc/) submodule)

- AX.25, HDLC, KISS, TNC2, CRC-CCITT

**Networking and IPC** (in [libcomm](libs/libcomm/) submodule)

- TCP, UDP, UDS

**DSP** (libdsp.a)

- `bf_lpf_*` / `bf_hpf_*` / `bf_bpf_*`: Butterworth filters (LPF, HPF, BPF)
- `bf_biquad_*`: Biquad high-boost EQ at 2200 Hz
- `agc_*` / `agc2_*`: Two AGC variants (standard and alternative)
- `fft_*`: Cooley-Tukey radix-2 FFT; pre-computed twiddles
- `grz_*` (Goertzel): Tone detection algorithm

**Core** (mw_core)

- `ring_*`: Lock-free ring buffers (thread-safe read/write)

Plus [libtnc](libs/libtnc/) for: buffer, line, common (logging)

**Modem** (mw_modem)

- `modem_*`: Wrapper for RX/TX chains (delegates to md_rx/md_tx)
- `md_multi_rx_*`: Up to 6 parallel demodulators with deduplication
- `md_rx_*` / `md_tx_*`: Single RX/TX chain (modem state machine)
- `demod_*`: Six demodulator types (flags: DEMOD_GOERTZEL_OPTIM, DEMOD_GOERTZEL_PESIM, DEMOD_QUADRATURE, DEMOD_SPLIT_MARK, DEMOD_SPLIT_SPACE, DEMOD_RRC)
- `demod_goertzel_*`, `demod_quad_*`, `demod_split_*`, `demod_rrc_*`: Demodulator implementations
- `bitclk_*`: PLL-based bit clock recovery with lock detection (floating-point)
- `mod_*`: FSK modulation (mark=2200 Hz, space=1200 Hz)
- `sql_*`: Squelch gate (AGC + energy threshold, configurable strength)
- `dedupe_*`: Frame deduplication by CRC with expiration window

**Main Programs**

- `main.c`: Initialize audio, args, loop control; cleanup
- `loop.c`: Real-time packet routing (audio→demod→output; stdin/TCP→modulation→audio)
- `audio.c`: ALSA initialization and callback glue
- `args.c`: CLI argument parsing (argp library)
- `main_bench.c`: Offline demod from binary audio files (F32/F64/S8/S16/S32/U8/U16/U32, LE/BE)
- `main_cal.c`: Real-time FFT spectrum analyzer (8 frequency bins, 1200 Hz reference)
- `main_log.c`: TCP/UDP packet logger for AX.25 RF traffic
- `main_test.c`: Unit test runner

## Demodulation Strategy

Up to six parallel demodulators run simultaneously in `md_multi_rx_*`:

- **Goertzel optimized**: Fast, low-latency Goertzel algorithm
- **Goertzel pessimistic**: Robust, higher SNR requirement
- **Quadrature**: Alternative mixer-based approach
- **Split-filter mark**: Branch targeting 2200 Hz
- **Split-filter space**: Branch targeting 1200 Hz
- **RRC (experimental)**: Root-raised-cosine filter with DDS oscillators and FIR (unsatisfactory performance)

Each produces soft bits → PLL-based bit clock recovery → hard symbols → HDLC deframer. Multi-RX deduplication by CRC.

## Logging

Macros in `common.h`, output to stderr, auto-includes function name:

- `LOG(str, ...)`: Always visible
- `LOGV(str, ...)`: With `--verbose`
- `LOGD(str, ...)`: With `--debug` only
- `EXIT(code, str, ...)`, `EXITIF(cond, code, ...)`: Fatal errors
- `nonnull(val, name)`, `nonzero(val, name)`: Input validation (exit -2/-3)

Messages: lowercase start, no period/newline (auto-added).

## Build

**Three libraries** (independent compilation):

- `libdsp.a`: agc, fft, filter, goertzel, synth, mavg
- `mw_core`: ring
- `mw_modem`: bitclk, demod, demod_goertzel, demod_quad, demod_rrc, demod_split, mod, modem, squelch, dedupe

**Executables**:

- `miniwolf`: main.c + audio.c + loop.c + args.c + all libraries + ALSA
- `mw_test`: main_test.c + test.c + args.c + all libraries (no ALSA)
- `mw_bench`: main_bench.c + all libraries (no ALSA)
- `mw_cal`: main_cal.c + audio.c + all libraries + ALSA

**Makefile targets**: `build`, `release`, `test`, `run`, `cal`, `clean`, `prof`, `bench1`, `bench2`

## Unit Testing

- Test files: `test_*.h` (functions matching `void test_name(void)`)
- Added to `main_test.c`
- Run via `make test`
- Use assertion macros from `test.h`
- Test: normal operation, boundary conditions (empty/full/wrap), init/free, diverse inputs
